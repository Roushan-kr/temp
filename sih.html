<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI-Powered System Flowchart</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mermaid.js -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <style>
    .mermaid .label { color: #333; }
    .mermaid .actor { fill: #f9f9f9; stroke: #333; }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #fff;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-start min-h-screen p-4 sm:p-8 space-y-8">
  
  <!-- Flowchart Viewer -->
  <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-7xl">
    <div class="flex flex-col sm:flex-row justify-center items-center mb-6 gap-4">
      <h1 class="text-xl sm:text-2xl font-bold text-center text-gray-800 dark:text-white">
        Unified LMS Ecosystem Flow
      </h1>
      <button id="explainBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
        <span class="btn-text">✨ Explain This Flow</span>
      </button>
    </div>

    <!-- AI Explanation -->
    <div id="explanationContainer" class="hidden bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6 prose dark:prose-invert max-w-none transition-all duration-500">
      <h3 class="font-semibold text-lg text-gray-800 dark:text-white">✨ AI-Generated Explanation:</h3>
      <p id="explanationText" class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></p>
    </div>

    <!-- Mermaid Diagram -->
    <div id="diagramContainer" class="flex justify-center min-h-[400px]">
      <pre id="mermaidPre" class="mermaid text-gray-800 dark:text-gray-200">
      graph TD
    subgraph Core_Systems_Services["Core Systems & Services"]
        F1["ML / AI Engine"]
        F2["Central DB (SQL / Redis)"]
        F3["Notification Service"]
        F4["External APIs <br/>(Library, Web Scraper)"]
    end

    subgraph Student
        A1["Personalized Calendar & Goals"]
        A2["Learning Interface <br/>(Assignments, Resources)"]
        A3["Attendance Interface <br/>(QR Code Submission)"]
        A4["Gamified Profile & Vault"]
    end

    subgraph Teacher
        B1["Learning Management <br/>(Coursework Hub)"]
        B2["Attendance Management <br/>(QR Gen, Proxy Detection)"]
        B3["Class / Module Analytics"]
    end

    subgraph TPC_Counsellor["TPC / Counsellor"]
        C1["Student Analytics Dashboard"]
        C2["Profile Review & Communication"]
        C3["Placement & Training Insights"]
    end

    subgraph Clubs_Community["Clubs / Community"]
        D1["Event & Club Pages"]
        D2["Chat & Networking <br/>(Discord-like)"]
        D3["Centralized Event Management"]
    end

    subgraph University_Govt["University / Govt"]
        E1["Master Profile Management"]
        E2["Unified Analytics Dashboard"]
        E3["Policies, Partnerships & MOUs"]
    end

    %% Student → Core Systems
    A1 --> F2
    A2 --> F2
    A3 --> F2
    A4 --> F2
    A2 -->|Submits Assignments / Views Content| B1
    A3 -->|Submits Attendance Data| B2
    A4 -->|Profile Data| C1

    %% AI Suggestions
    F1 -->|Goal & Event Suggestions| A1
    F1 -->|Book Recommendations| A2
    F1 -->|Sentiment & Strength Scores| A4

    %% Notifications
    F3 -->|Sends Notifications| A1

    %% Teacher → Core Systems
    B1 --> F2
    B2 --> F2
    B3 --> F2
    B1 -->|Publishes Content / Grades| A2
    B2 -->|Attendance List & Proxy Flags| F1
    B3 -->|Teacher Analytics| C1

    %% TPC / Counsellor
    C1 --> F2
    C2 --> F2
    C3 --> F2
    C1 -->|Analyzes Data from| A4
    C1 -->|Analyzes Data from| B3
    C1 -->|Aggregated Insights| E2
    C2 -->|Views Profiles / Communicates| A4
    C3 -->|Placement & Training Opps| F3

    %% Clubs / Community
    D1 --> F2
    D2 --> F2
    D3 --> F2
    D1 -->|Publishes Events| F3
    D1 -->|Event Data| E2
    D3 -->|Event Management| E3

    %% University / Govt
    E1 --> F2
    E2 --> F2
    E3 --> F2
    E1 -->|Manages Profiles| F2
    E2 -->|Consumes Analytics| C1
    E2 -->|Consumes Analytics| D1
    E3 -->|Policy / Partnership Info| F3

    %% External Data
    F4 --> F1
    F1 -->|Processes Data & Writes Insights| F2

      </pre>
    </div>
  </div>

  <!-- AI Flowchart Generator -->
  <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-4xl">
    <h2 class="text-xl sm:text-2xl font-bold text-center text-gray-800 dark:text-white mb-4">
      ✨ Generate Flowchart from Description
    </h2>
    <p class="text-center text-gray-500 dark:text-gray-400 mb-6">
      Describe a process, and Gemini will create a flowchart for you.
    </p>
    <textarea id="promptInput" class="w-full h-32 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="e.g., A user logs into the website..."></textarea>
    <div class="text-center mt-4">
      <button id="generateBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 flex items-center justify-center mx-auto gap-2">
        <span class="btn-text">Generate</span>
      </button>
    </div>
  </div>

  <script>
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'default',
      flowchart: { useMaxWidth: true, htmlLabels: true }
    });

    const API_KEY = "YOUR_API_KEY_HERE"; // Replace with your real API key
    const explainBtn = document.getElementById("explainBtn");
    const explanationContainer = document.getElementById("explanationContainer");
    const explanationText = document.getElementById("explanationText");
    const diagramContainer = document.getElementById("diagramContainer");
    let mermaidPre = document.getElementById("mermaidPre");

    function showError(message) {
      diagramContainer.innerHTML = `<div class="text-red-500 text-center p-4 bg-red-50 dark:bg-gray-700 rounded-lg">
        <strong>Error:</strong><br>${message}</div>`;
    }

    async function callGeminiAPI(userQuery, systemPrompt) {
      if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") {
        throw new Error("API key is not configured");
      }
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] }
      };
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API Error: ${errorData.error?.message || 'Unknown error'}`);
      }
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || "";
    }

    function toggleButtonLoading(button, isLoading, originalText) {
      const textSpan = button.querySelector('.btn-text');
      button.disabled = isLoading;
      if (isLoading) {
        textSpan.textContent = 'Processing...';
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        button.prepend(spinner);
      } else {
        textSpan.textContent = originalText;
        const spinner = button.querySelector('.spinner');
        if (spinner) spinner.remove();
      }
    }

    explainBtn.addEventListener('click', async () => {
      toggleButtonLoading(explainBtn, true, '✨ Explain This Flow');
      explanationContainer.classList.add('hidden');
      try {
        const mermaidCode = mermaidPre.innerText;
        const systemPrompt = "You are a helpful system architect...";
        const userPrompt = `Please explain this flowchart:\n\n\`\`\`mermaid\n${mermaidCode}\n\`\`\``;
        const explanation = await callGeminiAPI(userPrompt, systemPrompt);
        explanationText.innerText = explanation;
        explanationContainer.classList.remove('hidden');
      } catch (error) {
        showError(error.message);
      } finally {
        toggleButtonLoading(explainBtn, false, '✨ Explain This Flow');
      }
    });

    const generateBtn = document.getElementById("generateBtn");
    const promptInput = document.getElementById("promptInput");
    generateBtn.addEventListener('click', async () => {
      const userInput = promptInput.value.trim();
      if (!userInput) {
        showError("Please enter a description for the flowchart.");
        return;
      }
      toggleButtonLoading(generateBtn, true, 'Generate');
      explanationContainer.classList.add('hidden');
      try {
        const systemPrompt = "You are an expert in system design and Mermaid.js...";
        const newMermaidCodeText = await callGeminiAPI(userInput, systemPrompt);
        const match = newMermaidCodeText.match(/```mermaid\n([\s\S]*?)\n```/);
        if (!match?.[1]) {
          throw new Error("Invalid flowchart syntax received from AI");
        }
        const finalCode = match[1];
        diagramContainer.innerHTML = '';
        const newPre = document.createElement('pre');
        newPre.className = 'mermaid text-gray-800 dark:text-gray-200';
        newPre.textContent = finalCode;
        diagramContainer.appendChild(newPre);
        await mermaid.run();
        mermaidPre = diagramContainer.querySelector('.mermaid');
      } catch (error) {
        showError(error.message);
      } finally {
        toggleButtonLoading(generateBtn, false, 'Generate');
      }
    });
  </script>
</body>
</html>
